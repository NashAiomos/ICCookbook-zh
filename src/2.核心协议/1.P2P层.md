https://wiki.internetcomputer.org/wiki/IC_P2P_(peer_to_peer)_layer



# P2P层

P2P层的任务是在子网的节点副本中传递协议消息。这些协议消息包括

- 用于实现共识的消息，例如，区块提案（block proposals），公证（notarizations）等（详见[共识层](#5 共识层)）
- 入口消息（详见消息路由层）



---



当边缘节点把消息发过来的时候，由副本 P2P 层接收消息、广播消息。

这些消息有：

* 用于实现共识的各种签名消息

* 用户客户端发来的输入消息

如果是用户发的输入消息，P2P 层把这些消息按先后顺序排好，以便共识层将荷载打包出块。

P2P 层基本上是个广播通道。它的设计目的是为了确保如果一个诚实的副本广播了一条消息，那么这条消息最终将会被子网中的所有诚实节点所接收。P2P 层要负责保障高吞吐量，高吞吐量比低延迟更重要。并且故障的机器不影响诚实副本之间的相互通信。



---





注意到，在共识协议中，一些消息，尤其是区块提案（会非常大），将被所有副本反复广播。这对确保协议的正确运作是必须的。但是，如果单纯这样实现，将会是巨大的资源浪费。为了避免副本广播相同的消息，P2P层使用了**公告-请求-传递**的机制。它不会直接传递（大）消息，而是广播该消息的（小）**公告**：如果副本收到这样的公告并且没有收到过对应的消息，将认定该消息是重要的，副本将**请求**该消息的**传递**。这个策略以更高延迟的代价，降低了带宽使用。对于小消息而言，牺牲延迟追求带宽是不值得的，可以直接发送消息而不是公告。



对于相对较小的子网而言，希望广播消息的节点副本，会将公告发送至子网中的所有节点副本。对于较大的子网，**公告-请求-传递**机制可以在一个**覆盖网络（overlay network）**上运行。覆盖网络是一个连接的无向图，子网内的节点副本组成其顶点。如果图中有一条边连接两个副本，那他们是**对等节点（peers）**，副本仅和它的对等节点通信。因此，当副本希望广播消息时，他将该消息的公告发送给它的对等节点。这些对等节点在收到公告后，可能会请求消息的传递，如果满足特定条件，这些对等节点会将该消息的公告发送给他们的对等节点。这本质上是一个**gossip network**。这个策略用比先前更高的延迟代价，再次降低了带宽使用。



