# 执行层

执行环境每次处理一条输入，该输入取自输入队列中并被导向容器。取决于该条输入以及容器的状态，执行环境更新容器的状态并可以额外添加消息至输出队列，并且更新入口历史（可能连同此前入口消息的响应）。

在给定轮次，执行环境将处理多条输入。**调度器（Scheduler）**会判断哪些输入按何种顺序下将在指定轮次中执行。我们这里不深入讨论过多调度器的细节，而是着重强调一些目标：

-   它必须是*确定性的*，即仅仅取决于给定数据；
-   它应当*公平*的在容器间分布工作量（但对*吞吐*而不是*延迟*进行优化）。
-   每轮的完成的工作量使用*cycles*（详见[章节1.8](#1.8 功能代币)）为计量单位，且应当接近一些预先设定的数量。

另一个执行环境必须处理的任务是，当某子网的容器的生产跨子网消息的速度，比其他子网能够消耗的速度更快的情况。针对该情况，我们实现了一种自我监管的机制用于给生产容器降速。

运行环境还要处理许多其他的资源管理以及簿记任务，但是，所有这些任务都须确定地得到处理。





## 随机磁带

每个子网都拥有**分布式伪随机生成器（以下简称PRG）**的访问权限。如[第3章](#3 链钥密码学I：阈值签名)提及的，伪随机位可以从一个由$(f+1)/n$的BLS阈值签名衍生而来，被称为**随机磁带**。共识协议的每一轮都有一个不同的随机磁带。虽然此BLS签名与共识中使用的随机信标的签名相似（详见[章节5.5](#5.5 随机信标)），其机制却略有不同。

在共识协议中，一旦块高$h$的区块被最终确认，每个诚实节点将释放其在$h+1$块高下随机磁带中的片段。此处隐藏两点含义：

1. 在块高$h$的区块被任何诚实节点副本最终确认前，块高$h$+1的随机磁带是被确保为不可预测的。
2. 在块高$h+1$的区块被任何诚实节点副本确认时，该节点副本一般将拥有所有所需的片段以构建块高$h+1$的随机磁带。

例如在轮次$h$时，子网为获得二进制伪随机数，需要从执行层发起“系统调用”。当块高$h+1$的随机磁带可用时，系统随后就会响应该请求。根据上述的特性（1），我们可以确保在请求发起时，被请求的二进制伪随机数是不可预测的。基于上述的特性（2），一般在下个区块被最终确认时，被请求的二进制伪随机数即可获取。事实上，在当前的实现中，在块高$h$的区块被最终确认时，共识层（详见[章节5](#5 共识层)）将会同时递交块高$h$的区块（其荷载）以及$h+1$的随机磁带来给消息路由层处理。







> 你好开发团队，由于代码执行和费用是相关的，开发人员有什么防御措施来防止对他们的容器进行恶意垃圾邮件攻击以耗尽他们的周期？
>
> 另外，ICP 的用户是否也支付周期费用，或者只有 ICP 上的应用程序所有者支付周期费用？

由于代码执行和费用是相关的，开发人员有什么防御措施来防止对他们的容器进行恶意垃圾邮件攻击以耗尽他们的周期？

容器每次执行更新消息时，都必须以 Cycles 为单位进行支付。无论消息是由用户还是由容器发送，都是如此。如果容器没有足够的周期，则它无法执行消息。

这意味着这里有一个明显的攻击场景，其中恶意容器可以向受害容器发送虚假消息以使其耗尽其周期。我们目前有两种类型的缓解措施。

* 当用户向容器发送消息时，它们被称为入口消息。容器可以在 Internet 计算机接受 Ingress 消息进行处理之前检查它。如果容器拒绝该消息，则不会接受该消息进行处理，并且容器无需支付任何费用。有关此 API 的更多详细信息，请参阅[https://sdk.dfinity.org/docs/interface-spec/index.html#system-api-inspect-message 。](https://sdk.dfinity.org/docs/interface-spec/index.html#system-api-inspect-message)
* 当容器向另一个容器发送消息时，它们被称为容器间消息。发送容器必须为请求的传输和最终响应的传输支付费用。查看这些操作的当前费用 ( https://github.com/dfinity/ic/blob/master/rs/config/src/subnet_config.rs#L120 )，如果恶意容器决定攻击受害者容器，它将是一次相当昂贵的攻击。将来，我们计划引入类似的消息检查方案，以进一步保护容器免受其他恶意容器的侵害。由于执行此攻击的成本很高，因此优先级被认为不那么高。

此外，ICP 的用户是否也支付周期费用或仅 ICP 上的应用程序所有者支付周期费用

我们有一个所谓的接收者支付模型。因此，当容器或用户向另一个容器发送消息时，接收容器会为执行付费。

我希望这有帮助！



> 查询电话的费用如何？这些周期也会消耗在查询调用下的恶意攻击中吗？

你好。目前查询电话是“免费的”。我们确实对它们进行了速率限制，因此在一段时间内，给定容器可以使用的指令数量有限，无法为查询提供服务。我们还有边界节点，它限制有多少请求可以命中 IC 上的给定节点。这意味着两件事：

* 目前处理查询不收取任何费用。
* 恶意用户有可能在这个时间段用完您的所有查询预算，而您的诚实用户必须等待下一个时间段才能让他们的查询得到答复。

我们知道目前的情况并不理想，并且确实想解决它。一种想法是也为查询提供类似于检查消息 API 的东西。在这里，我们将在执行查询之前询问容器是否真的要执行查询，并将其计入其预算。

我们也总是对其他想法持开放态度，以了解如何最好地为罐子充电以备查询，以及如何保护罐子免受这种表面积的攻击。



> 请问储存费，比如是每小时扣一次，还是每秒扣一次？我在这里看到成本配置：

该费用在每轮共识中收取一次。每一轮，子网都会就“当前”时间达成一致。所以我们计算自上一轮以来已经过去了多少秒，并相应地收取费用。有关其实现方式，请参见https://github.com/dfinity/ic/blob/master/rs/cycles_account_manager/src/lib.rs#L568 。