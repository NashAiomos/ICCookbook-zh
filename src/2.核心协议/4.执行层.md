# 执行层

执行环境每次处理一条输入，该输入取自输入队列中并被导向容器。取决于该条输入以及容器的状态，执行环境更新容器的状态并可以额外添加消息至输出队列，并且更新入口历史（可能连同此前入口消息的响应）。

在给定轮次，执行环境将处理多条输入。**调度器（Scheduler）**会判断哪些输入按何种顺序下将在指定轮次中执行。我们这里不深入讨论过多调度器的细节，而是着重强调一些目标：

-   它必须是*确定性的*，即仅仅取决于给定数据；
-   它应当*公平*的在容器间分布工作量（但对*吞吐*而不是*延迟*进行优化）。
-   每轮的完成的工作量使用*cycles*（详见[章节1.8](#1.8 功能代币)）为计量单位，且应当接近一些预先设定的数量。

另一个执行环境必须处理的任务是，当某子网的容器的生产跨子网消息的速度，比其他子网能够消耗的速度更快的情况。针对该情况，我们实现了一种自我监管的机制用于给生产容器降速。

运行环境还要处理许多其他的资源管理以及簿记任务，但是，所有这些任务都须确定地得到处理。

## 随机磁带

每个子网都拥有**分布式伪随机生成器（以下简称PRG）**的访问权限。如[第3章](#3 链钥密码学I：阈值签名)提及的，伪随机位可以从一个由$(f+1)/n$的BLS阈值签名衍生而来，被称为**随机磁带**。共识协议的每一轮都有一个不同的随机磁带。虽然此BLS签名与共识中使用的随机信标的签名相似（详见[章节5.5](#5.5 随机信标)），其机制却略有不同。

在共识协议中，一旦块高$h$的区块被最终确认，每个诚实节点将释放其在$h+1$块高下随机磁带中的片段。此处隐藏两点含义：

1. 在块高$h$的区块被任何诚实节点副本最终确认前，块高$h$+1的随机磁带是被确保为不可预测的。
2. 在块高$h+1$的区块被任何诚实节点副本确认时，该节点副本一般将拥有所有所需的片段以构建块高$h+1$的随机磁带。

例如在轮次$h$时，子网为获得二进制伪随机数，需要从执行层发起“系统调用”。当块高$h+1$的随机磁带可用时，系统随后就会响应该请求。根据上述的特性（1），我们可以确保在请求发起时，被请求的二进制伪随机数是不可预测的。基于上述的特性（2），一般在下个区块被最终确认时，被请求的二进制伪随机数即可获取。事实上，在当前的实现中，在块高$h$的区块被最终确认时，共识层（详见[章节5](#5 共识层)）将会同时递交块高$h$的区块（其荷载）以及$h+1$的随机磁带来给消息路由层处理。